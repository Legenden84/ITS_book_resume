# 6.1 Race Conditions and Resolving Filenames to Resources

In this section, we delve into the critical issue of race conditions, with a particular focus on filesystem races, and the broader challenge of resolving filenames to their expected resources. This discussion extends the principles outlined in Chapters 1 and 5, especially principle P4 (COMPLETE-MEDIATION), which emphasizes the necessity of verifying authorization immediately before granting access to a resource.

## TOCTOU Race Conditions

Time-Of-Check to Time-Of-Use (TOCTOU) races occur when there's a gap between when a condition is checked (at time t1) and when the object is accessed (at time t2 > t1), allowing the state of the system to change in the interim. In multiprocessor systems with interrupts, this could involve changes in file permissions, owners, or the objects filenames resolve to. A prevalent example in Unix systems involves a root-owned setuid program that performs a permission check using `access()` before writing to a file. An attacker can exploit the gap between this check and the file access to escalate privileges and overwrite critical files, such as `/etc/passwd`. This vulnerability highlights the need for special attention to TOCTOU races by system designers and developers.

## Mitigating Race Conditions

Addressing race conditions requires ensuring atomicity of operations. Disabling interrupts is not a feasible solution due to practical constraints and potential negative impacts on system performance. Alternatives include adjusting effective user IDs before opening files or using a forked unprivileged child process to open the file, though these solutions may face portability issues across different operating systems. A general recommendation is to use system calls that directly deal with file descriptors whenever possible, as they are not subject to changes like filenames are.

## Resolving Filenames Safely

Ensuring filenames resolve safely to the expected resources is a complex challenge, as demonstrated through a scenario involving controlled directories and file permissions. Even if a user has exclusive permissions on a directory and creates a file within it, malicious users with control over parent directories can manipulate the filesystem to resolve the filename to a different resource. This underscores the need for caution and thorough validation mechanisms when aiming to guarantee safe filename resolution.

## /tmp File Exploits

A typical exploit scenario is presented involving world-writable directories like `/tmp`, commonly used by utility programs for temporary files. Attackers can perform "filename squatting" attacks by anticipating the creation of temporary files by processes like compilers and preemptively creating symbolic links to other critical files. This can lead to overwriting of those files if the attacking process has sufficient privileges, demonstrating the necessity for robust security practices even in the handling of temporary files and directories.

