# 6.4 Heap-based Buffer Overflows and Heap Spraying

## Introduction
Heap-based buffer overflows affect buffers in heap memory and the data segment, with systems often leaving the heap writable and executable. This section explores these vulnerabilities and introduces heap spraying as a method of exploitation.

## Heap and Data Segment Vulnerabilities
- **Writable and Executable Memory**: Traditionally, the heap and BSS are both writable and executable, introducing potential security risks. Data segments can also be subdivided into read-only and read-write sections.
- **Writability of Various Segments**: Apart from the heap, other writable segments like environment variables and command-line arguments can be manipulated.

### Heap-based Exploits
- **Buffer Allocation in BSS**: Buffers in BSS can be allocated using C declarations.
- **Overflowing Higher-Address Variables**: Attackers exploit buffers and manipulate higher memory address variables without crashing the system. This can be done by corrupting access control data or overwriting function pointers to transfer control to attacker-selected code.

## Types of State Corrupted
Understanding the types of variables involved is crucial:
a) Stack-based pointers, including return addresses and frame pointers.
b) Function pointers across stack, heap, or static areas.
c) Addresses used in C-language setjmp/longjmp functions.
d) Data used in branching tests, manipulating program flow indirectly.

## Generic Exploit Steps
Buffer overflow and related exploits generally follow three steps:
1. **Code Injection or Location**: Place the attacker’s code within the target’s address space.
2. **Corruption of Control Flow Data**: Overwrite data structures, setting up for transfer of control.
3. **Seizure of Control**: Transfer program control to the attacker’s code.

## Heap Spraying
- **Introduction**: Heap spraying places numerous instances of attacker-chosen code in the heap, preparing for step 1 in generic exploit steps.
- **Usage in Drive-By Download Attacks**: This technique is popular in exploiting browsers through drive-by download attacks, often using JavaScript.
- **Implementation**: The attack involves allocating a large number of heap objects with content chosen by the attacker, arranged via scripts embedded in HTML pages or through image loading on web pages.
- **Step 2 and Transfer to Heap**: Any means, such as corrupting a function pointer, can be used to transfer program control to the heap.
- **Increasing Success Probability**: The more objects and longer the no-op sleds, the higher the chance of a successful transfer to the heap. Knowledge of typical memory layout is used to increase success probability.
- **Defenses**: Heap spraying is not stopped by defenses that randomize heap layout and it can be implemented in type-safe languages like JavaScript.
